<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <script src="https://kit.fontawesome.com/d82fdbf1c7.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <title>Document</title>
</head>

<body>
    <div id="app">
        <header>
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <a class="navbar-brand" href="#">Navbar</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" @click="printUser()" href="#">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="!#" @click.prevent="showloginsignup">Login/SignUp</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/logout">Logout</a>
                        </li>
                    </ul>
                    <div class="username">
                        <h2 id="username"></h2>
                    </div>
                </div>
            </nav>
        </header>
        <main>
        <form>
            <input id="postTitle" class="form-control" type="text" name="title"
                placeholder="Topic.."> <br>
            <input id="postBody" class="form-control" type="text" name="body"
                placeholder="Type here.."> <br>
            <button v-on:click="startTopic" type="submit">Start Topic</button>
        </form>
        <div id="posts">
            <div v-for="post in posts" v-bind:key="post.id">
                <div class="post-header">
                    <h5> {{ post.title }} - By: {{ post.username }}</h5>
                </div>
                <div class="post-body">
                    <p>{{ post.body }}</p>
                </div>
                <div>
                    <form>
                    <button @click="likePost(post.postID)" type="submit" class="btn"><i class="fa fa-thumbs-up fa-lg" aria-hidden="true"></i></button>
                    <button class="btn" @click="dislikePost(post.postID)" type="submit"><i class="fa fa-thumbs-down fa-lg" aria-hidden="true"></i></button>
                    <span id="postLikes">{{ post.likes }}</span>
                    </form>
                </div>
                <div class="post-footer">
                    <button class="CRUD" v-on:click="showEditModal(post.postID)">Edit</button>
                    <button class="Comment" v-on:click="showReplyModal(post.postID)">View/Reply</button>
                </div>
                <!-- Edit Modal -->
                <div class = "modal fade" id="editModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                Edit topic
                            </div>
                            <div class="modal-body">
                                <div class="modal-body-top">
                                    <input type="text" id="editTitle">
                                    <p id = "postID"></p>
                                </div>

                                <textarea name="body-edit" id="bodyEdit" cols="60" rows="5"></textarea>
                            </div>
                            <div class="modal-footer">
                                <h1>Robins föötfettich </h1>
                                <!-- !! REMOVE/ EDIT-->
                                <form>
                                <button class="btn btn-primary" id="updatePost" v-on:click="updatePost">Update</button>
                                <button type="submit" class="btn btn-danger" id="delete-post" v-on:click="removePost">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reply Modal -->
                <div class="modal fade" id="replyModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="post-title"></h5>
                                <p id="post-author"></p>
                                <p id="post-id"></p>
                            </div>
                            <div class="modal-body">
                                <!-- Topic -->
                                <p id="post-body"></p>
                                <div>
                                    <div v-for="reply in replies">
                                        <h5>{{reply.username}}</h5>
                                        <h5>{{reply.reply}}</h5>
                                        <p id="replyID">{{reply.replyID}}</p>
                                        <div id="replyButtons">
                                            <button v-on:click="likeReply(reply.replyID)" class="btn" ><i class="fa fa-thumbs-up fa-lg" aria-hidden="true"></i></button>
                                            <button v-on:click="dislikeReply(reply.replyID)" class="btn" ><i class="fa fa-thumbs-down fa-lg" aria-hidden="true"></i></button>
                                            <span id="replyLikes">{{ reply.likes }}</span>
                                        </div>
                                        <div class="replyCrud">
                                            <!-- ? This is where the fun begins! ? -->
                                                <button class="removeReply btn btn-danger" @click = "removeReply">Delete</button>
                                                <button class="editReply btn btn-primary">Edit</button>

                                        </div>
                                    </div>
                                </div>
                                <!-- Replies -->
                                <div class="row">
                                    <div class="col-md-6 col-md-offset-3">
                                        <form>
                                            <textarea name="reply" id="reply-body" cols="60" rows="3"></textarea>
                                            <button class="btn btn-primary" v-on:click="makeReply()">Submit</button>
                                        </form>
                                        <!-- v-on:click tassarna  -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Reply Modal -->
            </div>
        </div>
        </main>
        <footer>
        </footer>
        <div class="modal fade" id="loginModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Login / Signup</h5>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 col-md-offset-3">
                                <h2>log in</h2>
                                <form action="/login" method="POST">
                                    <input id="logUsername" class="form-control" type="text" name="username"
                                        placeholder="Username"> <br>
                                    <input id="logPassword" class="form-control" type="password" name="password"
                                        placeholder="Password"> <br>
                                    <button>Log in</button>
                                </form>
                            </div>
                            <div class="col-md-6 col-md-offset-3">
                                <h2>Sign up</h2>
                                <form action="/signup" method="POST">
                                    <input id="addUsername" class="form-control" type="text" name="username"
                                        placeholder="Username"> <br>
                                    <input id="addEmail" class="form-control" type="email" name="email"
                                        placeholder="Email"> <br>
                                    <input id="addName" class="form-control" type="text" name="name" placeholder="Name">
                                    <br>
                                    <input id="addPassword" class="form-control" type="password" name="password"
                                        placeholder="Password"> <br>
                                    <button type="submit">Sign Up</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script>
        const vm = new Vue({
            el: "#app",
            data: {
                posts: [],
                replies: [],
                currentUser: {}
            },
            methods: {
                showloginsignup() {
                    $("#loginModal").modal("show");
                },
                showReplyModal(id){

                    $("#replyModal").modal("show");
                    $.ajax({
                        url: "/post/" + id,
                        type: "GET",
                        success : (post) =>{
                            $('#post-id').html(post.postID);
                            $('#post-author').html(post.username);
                            $('#post-title').html(post.title);
                            $('#post-body').html(post.body);
                            $.ajax({
                                url: "/reply/" + id,
                                type: "GET",
                                success: (reply) =>{
                                    console.log('Singular reply?' + JSON.stringify(reply));
                                    this.replies = reply;
                                    console.log('This is the reply: ' + JSON.stringify(reply));
                                    console.log(self.replies);
                                }
                            });
                        }
                    });
                },
                showEditModal(id){
                    $("#editModal").modal("show");
                    $.ajax({
                        url: "/post/" + id,
                        type: "GET",
                        success: (post)=>{
                            $('#postID').html(post.postID);
                            $('#editTitle').val(post.title);
                            $('#bodyEdit').html(post.body);
                        }
                    })
                },
                startTopic(){
                    let post = {
                        title: $("#postTitle").val(),
                        body: $("#postBody").val(),
                    };
                    $.ajax({
                        url: "/post",
                        type: "POST",
                        data: post
                    });
                },
                makeReply(){
                    let reply = {
                        postID: $("#post-id").html(),
                        reply: $("#reply-body").val()
                    }
                    $.ajax({
                        url: "/reply",
                        type: "POST",
                        data: reply
                    });
                },
                likePost(postID){
                    $.ajax({
                        url: "/postLike/" + postID,
                        type: "POST",
                        success: () => {
                            this.getLikes(postID);
                        }
                    });
                },
                getLikes(postID){
                    $.ajax({
                        url:"/post/" + postID,
                        type: "GET",
                        success: (postLikes) => {
                            $("#postLikes").html(postLikes.likes);
                            $.getJSON("/posts", function (jsondata) {
                            self.posts = jsondata;
                            });
                        }
                    });
                },
                dislikePost(postID){
                    $.ajax({
                        url: "/postdislike/" + postID,
                        type: "GET",
                        success: ()=>{
                            this.getLikes(postID);
                        }
                    });
                },
                likeReply(replyID){
                    $.ajax({
                        url: "/replylike/" + replyID,
                        type: "POST",
                        success: () => {
                            this.getReplyLikes(replyID);
                        }
                    });
                },
                getReplyLikes(replyID){
                    $.ajax({
                        url:"/replies/" + replyID,
                        type: "GET",
                        success: (replyLikes) => {
                            $("#replyLikes").html(replyLikes.likes);
                        }
                    });
                },
                dislikeReply(replyID){
                    $.ajax({
                        url: "/replydislike/" + replyID,
                        type: "GET",
                        success: ()=>{
                            this.getReplyLikes(replyID);
                        }
                    });
                },
                updatePost(){
                    const postEdit = {
                        postID:  $('#postID').html(),
                        postTitle: $('#editTitle').val(),
                        postBody: $('#bodyEdit').val()
                    }
                    $.ajax({
                        url: "/updatePostByID/" + postEdit.postID,
                        type: "PUT",
                        data: postEdit,
                        success: (post)=>{
                            $("#postTitleSpan").html(post.postTitle);
                            $("#postBodySpan").html(post.postBody);
                        }
                    })
                },
                removePost(){
                    const id = $("#postID").html();
                    $.ajax({
                        url: "/removePost/" + id,
                        type: "DELETE",
                        success: () => {
                            $.getJSON("/posts", function (jsondata) {
                            self.posts = jsondata;
                            });
                        }
                    });
                    $("#editModal").modal("hide");
                },
                removeReply(){
                    const id = $("#replyID").html();
                    $.ajax({
                        url: "/removeReply/" + id,
                        type: "DELETE",
                    })
                }

            },
            mounted() {
                var self = this;
                $.getJSON("/posts", function (jsondata) {
                self.posts = jsondata;
                });
            },
        });
    </script>


</body>

</html>